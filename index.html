<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biotech | Tarifa 2026 - Grupo Vista</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React y Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Librerías para Excel con Imágenes -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .aspect-square { aspect-ratio: 1 / 1; }
        @keyframes slideIn { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-in { animation: slideIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useRef, useEffect } = React;

        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                package: <path d="M16.5 9.4 7.5 4.21M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z" />,
                download: <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3" />,
                search: <React.Fragment><circle cx="11" cy="11" r="8" /><path d="m21 21-4.3-4.3" /></React.Fragment>,
                x: <path d="M18 6 6 18M6 6l12 12" />,
                camera: <React.Fragment><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z" /><circle cx="12" cy="13" r="3" /></React.Fragment>,
                "trending-down": <React.Fragment><polyline points="22 17 13.5 8.5 8.5 13.5 2 7" /><polyline points="16 17 22 17 22 11" /></React.Fragment>,
                "trending-up": <React.Fragment><polyline points="22 7 13.5 15.5 8.5 10.5 2 17" /><polyline points="16 7 22 7 22 13" /></React.Fragment>,
                plus: <path d="M5 12h14M12 5v14" />,
                "alert-circle": <React.Fragment><circle cx="12" cy="12" r="10" /><line x1="12" x2="12" y1="8" y2="12" /><line x1="12" x2="12.01" y1="16" y2="16" /></React.Fragment>,
                info: <React.Fragment><circle cx="12" cy="12" r="10" /><path d="M12 16v-4M12 8h.01" /></React.Fragment>,
                "check-circle-2": <React.Fragment><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z" /><path d="m9 12 2 2 4-4" /></React.Fragment>,
                file: <React.Fragment><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></React.Fragment>
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || null}
                </svg>
            );
        };

        const ProductRow = ({ product, imageObj, onImageUpload, onImageRemove }) => {
            const fileInputRef = useRef(null);
            const diff = product.precioViejo ? product.precioNuevo - product.precioViejo : 0;
            const isDown = diff < 0;
            const isNew = product.precioViejo === null;

            return (
                <tr className="hover:bg-blue-50/20 transition-all group">
                    <td className="px-8 py-6">
                        <div className="relative aspect-square w-24 mx-auto bg-white rounded-2xl border-2 border-dashed border-slate-200 flex items-center justify-center overflow-hidden cursor-pointer hover:border-blue-500 transition-colors shadow-sm"
                             onClick={() => fileInputRef.current?.click()}>
                            {imageObj ? (
                                <React.Fragment>
                                    <img src={imageObj.url} alt={product.nombre} className="w-full h-full object-cover" />
                                    <div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity">
                                        <button onClick={(e) => { e.stopPropagation(); onImageRemove(product.id); }} className="bg-white p-2 rounded-full text-rose-500 hover:scale-110">
                                            <Icon name="x" size={16} />
                                        </button>
                                    </div>
                                </React.Fragment>
                            ) : (
                                <div className="flex flex-col items-center text-slate-300">
                                    <Icon name="camera" size={24} />
                                    <span className="text-[10px] font-black uppercase mt-1 text-center">Subir Foto</span>
                                </div>
                            )}
                            <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={(e) => onImageUpload(product.id, e)} />
                        </div>
                    </td>
                    <td className="px-6 py-6">
                        <div className="flex flex-col">
                            <span className="font-black text-slate-800 text-lg leading-tight">{product.nombre}</span>
                            <span className="text-[10px] font-black text-blue-600 uppercase tracking-widest mt-1">{product.cat}</span>
                            <p className="text-sm text-slate-500 mt-2 font-medium italic max-w-sm leading-snug">{product.desc}</p>
                        </div>
                    </td>
                    <td className="px-6 py-6 text-right font-mono text-slate-300 text-lg">{product.precioViejo ? `${product.precioViejo.toFixed(2)}€` : '---'}</td>
                    <td className="px-6 py-6 text-right font-black text-slate-900 text-2xl font-mono">{product.precioNuevo.toFixed(2)}€</td>
                    <td className="px-8 py-6 text-center">
                        <div className="flex justify-center">
                            {isNew ? (
                                <div className="bg-amber-50 text-amber-600 px-4 py-2 rounded-xl text-[10px] font-black uppercase border border-amber-200 flex items-center gap-2">
                                    <Icon name="plus" size={14} /> Nuevo
                                </div>
                            ) : (
                                <div className="bg-blue-50 text-blue-600 px-4 py-2 rounded-xl text-[10px] font-black uppercase border border-blue-200 flex items-center gap-2">
                                    <Icon name="alert-circle" size={14} /> Actualizar
                                </div>
                            )}
                        </div>
                    </td>
                </tr>
            );
        };

        const App = () => {
            const [searchTerm, setSearchTerm] = useState('');
            const [filterStatus, setFilterStatus] = useState('all');
            const [productImages, setProductImages] = useState({});
            const [notification, setNotification] = useState(null);
            const [isExporting, setIsExporting] = useState(false);

            const showToast = (message, type = 'success') => {
                setNotification({ message, type });
                setTimeout(() => setNotification(null), 4000);
            };

            const handleImageUpload = (id, event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        setProductImages(prev => ({ 
                            ...prev, 
                            [id]: { url: e.target.result, base64: e.target.result.split(',')[1], type: file.type.split('/')[1] } 
                        }));
                        showToast("Foto lista para el Excel");
                    };
                    reader.readAsDataURL(file);
                }
            };

            const removeImage = (id) => {
                setProductImages(prev => { const next = { ...prev }; delete next[id]; return next; });
                showToast("Foto eliminada", "info");
            };

            const products = [
                { id: 1, cat: 'LIO Fáquicas', nombre: 'Eyecryl Phakic Baja Potencia (SPH & TOR)', desc: 'SPH +0.50D a +2.75D / SPH -0.50D a -6D con CYL hasta +5D.', precioViejo: 625.00, precioNuevo: 500.00, estado: 'Actualizar' },
                { id: 2, cat: 'LIO Fáquicas', nombre: 'Eyecryl Phakic Alta Potencia (SPH)', desc: 'SPH +3.00 a +10D / SPH -6.50D a -25D.', precioViejo: 625.00, precioNuevo: 577.00, estado: 'Actualizar' },
                { id: 3, cat: 'LIO Fáquicas', nombre: 'Eyecryl Phakic Alta Potencia (TOR) - Cil 0.5/1.0D', desc: 'Excepción: Cilindros de 0.50D y 1.0D facturados como esféricas.', precioViejo: 950.00, precioNuevo: 577.00, estado: 'Actualizar' },
                { id: 4, cat: 'LIO Fáquicas', nombre: 'Eyecryl Phakic Alta Potencia (TOR) - Otros Cil', desc: 'SPH +3.00D a +10D / SPH -6.50D a -25D. CYL hasta +5D.', precioViejo: 950.00, precioNuevo: 800.00, estado: 'Actualizar' },
                { id: 5, cat: 'LIO Fáquicas', nombre: 'Eyecryl Phakic CUSTOM (SPH & TOR)', desc: 'SPH > -25D / +10D o CIL > +5D. Tallas especiales: 11, 11.5, 14 o tallas a medida', precioViejo: null, precioNuevo: 1250.00, estado: 'Nuevo' },
                { id: 6, cat: 'LIO Premium', nombre: 'OPTIFLEX TRIO 3FLA6', desc: 'Lente Trifocal. Visión nítida a múltiples distancias.', precioViejo: null, precioNuevo: 320.00, estado: 'Nuevo' },
                { id: 7, cat: 'LIO Premium', nombre: 'OPTIFLEX TRIO TORICA', desc: 'Trifocal con corrección de astigmatismo corneal.', precioViejo: null, precioNuevo: 420.00, estado: 'Nuevo' },
                { id: 8, cat: 'LIO Premium', nombre: 'OPTIFLEX TRIO PLUS (NEW)', desc: 'Nueva generación Trifocal con óptica mejorada.', precioViejo: null, precioNuevo: 420.00, estado: 'Nuevo' },
                { id: 9, cat: 'LIO Premium', nombre: 'OPTIFLEX XTENSE COMFORT PLUS (NEW)', desc: 'Continuous Vision. Tecnología avanzada sin halos.', precioViejo: null, precioNuevo: 420.00, estado: 'Nuevo' },
                { id: 10, cat: 'LIO Premium', nombre: 'EYECRYL SERT', desc: 'EDOF. Profundidad de foco extendida.', precioViejo: null, precioNuevo: 105.00, estado: 'Nuevo' },
                { id: 11, cat: 'LIO Premium', nombre: 'EYECRYL SERT TORIC CIL 1.0D', desc: 'EDOF Tórica para astigmatismos bajos.', precioViejo: null, precioNuevo: 200.00, estado: 'Nuevo' },
                { id: 12, cat: 'LIO Premium', nombre: 'EYECRYL SERT TORIC OTROS CILINDROS', desc: 'EDOF Tórica para corrección astigmática completa.', precioViejo: null, precioNuevo: 265.00, estado: 'Nuevo' },
                { id: 13, cat: 'LIO Premium', nombre: 'EYECRYL ACTV', desc: 'Multifocal bifocal hidrofóbica.', precioViejo: 210.00, precioNuevo: 200.00, estado: 'Actualizar' },
                { id: 14, cat: 'LIO Monofocal', nombre: 'OPTIFLEX GENESIS COMFORT NY', desc: 'Precargada con filtro amarillo.', precioViejo: null, precioNuevo: 59.00, estado: 'Nuevo' },
                { id: 15, cat: 'LIO Monofocal', nombre: 'EYECRYL PLUS NATURAL HD', desc: 'No precargada. Alta definición visual.', precioViejo: null, precioNuevo: 39.00, estado: 'Nuevo' },
                { id: 16, cat: 'Viscoelásticos', nombre: 'BIO HYALUR 1ML PFS', desc: 'Hialuronato Sódico 1%.', precioViejo: null, precioNuevo: 9.90, estado: 'Nuevo' },
                { id: 17, cat: 'Viscoelásticos', nombre: 'BIO HYALUR PLUS 1ML PFS', desc: 'Hialuronato Sódico 1.4%.', precioViejo: null, precioNuevo: 10.80, estado: 'Nuevo' },
                { id: 18, cat: 'Viscoelásticos', nombre: 'BIO HYALUR DUO', desc: 'Hialuronato Sódico 1.0% + 2.4%.', precioViejo: 22.95, precioNuevo: 24.00, estado: 'Actualizar' },
                { id: 19, cat: 'Viscoelásticos', nombre: 'BIO HYALUR LVD 1ML PFS', desc: '3% Hialuronato + 4% Condroitina.', precioViejo: null, precioNuevo: 24.50, estado: 'Nuevo' },
                { id: 20, cat: 'Viscoelásticos', nombre: 'BIO HYALUR HV 1ML PFS', desc: 'Hialuronato Sódico 2.4%. Alta viscosidad.', precioViejo: 15.00, precioNuevo: 12.00, estado: 'Actualizar' },
                { id: 21, cat: 'Viscoelásticos', nombre: 'BIO HYALUR SV 1ML PFS', desc: 'Hialuronato Sódico 3.0%. Super viscoso.', precioViejo: 16.00, precioNuevo: 12.00, estado: 'Actualizar' },
                { id: 22, cat: 'Viscoelásticos', nombre: 'EYEVISC 2% 2ML PFS', desc: 'Hidroxipropilmetilcelulosa.', precioViejo: 9.00, precioNuevo: 7.70, estado: 'Actualizar' },
                { id: 23, cat: 'Otros / VR', nombre: 'BIO BLUE 1ML PFS', desc: 'Colorante vital (Tripán Blue).', precioViejo: 72.50, precioNuevo: 9.25, estado: 'Actualizar' },
                { id: 24, cat: 'Otros / VR', nombre: 'BIOVISION PMMA CTR', desc: 'Anillo de tensión capsular.', precioViejo: 30.00, precioNuevo: 35.00, estado: 'Actualizar' },
                { id: 25, cat: 'Otros / VR', nombre: 'BIOBLUE 90 PLUS (ERM/ILM)', desc: 'Colorante para membranas retinianas.', precioViejo: null, precioNuevo: 39.00, estado: 'Nuevo' },
                { id: 26, cat: 'Otros / VR', nombre: 'BIOSIL 10ML', desc: 'Aceite de silicona para VR.', precioViejo: null, precioNuevo: 45.00, estado: 'Nuevo' },
                { id: 27, cat: 'Otros / VR', nombre: 'BIOSIL F 10ML', desc: 'Aceite de silicona variante F.', precioViejo: null, precioNuevo: 45.00, estado: 'Nuevo' },
                { id: 28, cat: 'Otros / VR', nombre: 'BIO OCTANE', desc: 'Líquido pesado (Perfluorooctano).', precioViejo: null, precioNuevo: 50.00, estado: 'Nuevo' },
                { id: 29, cat: 'Otros / VR', nombre: 'BIO DECALIN', desc: 'Líquido pesado (Perfluorodecalina).', precioViejo: null, precioNuevo: 50.00, estado: 'Nuevo' },
                { id: 30, cat: 'Otros / VR', nombre: 'IRIS RETRACTOR', desc: 'Retractores de iris (5 uds).', precioViejo: 50.00, precioNuevo: 30.00, estado: 'Actualizar' },
                { id: 31, cat: 'Otros / VR', nombre: 'BIORING', desc: 'Anillo intraestromal.', precioViejo: null, precioNuevo: 275.00, estado: 'Nuevo' },
            ];

            const filteredProducts = useMemo(() => {
                return products.filter(p => {
                    const matchesSearch = p.nombre.toLowerCase().includes(searchTerm.toLowerCase()) || p.cat.toLowerCase().includes(searchTerm.toLowerCase());
                    const matchesStatus = filterStatus === 'all' || (filterStatus === 'missing' && p.estado === 'Nuevo') || (filterStatus === 'update' && p.estado === 'Actualizar');
                    return matchesSearch && matchesStatus;
                });
            }, [searchTerm, filterStatus]);

            // FUNCIÓN MAESTRA: Exportar Excel con Imágenes Reales
            const exportToExcelWithImages = async () => {
                setIsExporting(true);
                showToast("Generando Excel con imágenes... espera un momento", "info");

                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet('Tarifa Biotech 2026');

                // Configurar Cabeceras
                worksheet.columns = [
                    { header: 'Miniatura', key: 'img', width: 20 },
                    { header: 'Categoría', key: 'cat', width: 20 },
                    { header: 'Producto', key: 'nombre', width: 35 },
                    { header: 'Especificaciones', key: 'desc', width: 45 },
                    { header: 'Precio Anterior', key: 'old', width: 15 },
                    { header: 'Precio 2026', key: 'new', width: 15 },
                ];

                // Estilo para la cabecera
                worksheet.getRow(1).font = { bold: true, color: { argb: 'FFFFFF' } };
                worksheet.getRow(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: '2563EB' } };

                // Añadir Datos
                for (let i = 0; i < products.length; i++) {
                    const p = products[i];
                    const rowIndex = i + 2;
                    const row = worksheet.addRow({
                        cat: p.cat,
                        nombre: p.nombre,
                        desc: p.desc,
                        old: p.precioViejo ? `${p.precioViejo} €` : '-',
                        new: `${p.precioNuevo} €`
                    });

                    row.height = 80; // Altura para que quepa la imagen
                    row.alignment = { vertical: 'middle', horizontal: 'left', wrapText: true };

                    // Si hay imagen cargada para este ID, incrustarla
                    const imgData = productImages[p.id];
                    if (imgData) {
                        try {
                            const imageId = workbook.addImage({
                                base64: imgData.base64,
                                extension: imgData.type === 'jpeg' ? 'jpg' : imgData.type,
                            });
                            worksheet.addImage(imageId, {
                                tl: { col: 0.1, row: rowIndex - 0.9 }, // Top Left
                                ext: { width: 100, height: 100 }       // Tamaño
                            });
                        } catch (e) { console.error("Error al añadir imagen al Excel", e); }
                    }
                }

                // Generar y descargar
                const buffer = await workbook.xlsx.writeBuffer();
                saveAs(new Blob([buffer]), "Tarifa_Biotech_2026_Con_Imagenes.xlsx");
                setIsExporting(false);
                showToast("¡Excel con imágenes descargado!");
            };

            return (
                <div className="min-h-screen p-4 md:p-8">
                    <div className="max-w-7xl mx-auto mb-8 bg-white p-6 rounded-[2rem] shadow-sm border border-slate-200">
                        <div className="flex flex-col md:flex-row md:items-center justify-between gap-6">
                            <div className="flex items-center gap-5">
                                <div className="bg-blue-600 p-4 rounded-2xl text-white shadow-xl">
                                    <Icon name="package" size={32} />
                                </div>
                                <div>
                                    <h1 className="text-3xl font-black text-slate-800 uppercase">Tarifa Biotech 2026</h1>
                                    <p className="text-slate-400 mt-2 font-bold text-sm tracking-wider uppercase">Grupo Vista | Con Exportación de Imágenes</p>
                                </div>
                            </div>
                            <button onClick={exportToExcelWithImages} disabled={isExporting} className="flex items-center gap-2 px-8 py-4 bg-emerald-600 text-white font-black rounded-2xl shadow-lg hover:bg-emerald-700 transition-all uppercase text-sm disabled:opacity-50">
                                <Icon name={isExporting ? "file" : "download"} size={18} /> {isExporting ? 'Generando...' : 'Descargar Excel con Fotos'}
                            </button>
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto mb-6 flex flex-col lg:flex-row gap-4">
                        <div className="relative flex-1">
                            <div className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"><Icon name="search" size={20} /></div>
                            <input type="text" placeholder="Buscar producto..." className="w-full pl-12 pr-6 py-4 bg-white border-0 rounded-2xl shadow-sm ring-1 ring-slate-200 focus:ring-4 focus:ring-blue-100 outline-none font-medium" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                        </div>
                        <div className="flex p-1.5 bg-white rounded-2xl shadow-sm ring-1 ring-slate-200 gap-1 overflow-x-auto">
                            <button onClick={() => setFilterStatus('all')} className={`px-6 py-2.5 rounded-xl text-xs font-black uppercase transition-all ${filterStatus === 'all' ? 'bg-slate-800 text-white shadow-md' : 'text-slate-500'}`}>Todas</button>
                            <button onClick={() => setFilterStatus('missing')} className={`px-6 py-2.5 rounded-xl text-xs font-black uppercase transition-all ${filterStatus === 'missing' ? 'bg-amber-500 text-white' : 'text-slate-500'}`}>Nuevas</button>
                            <button onClick={() => setFilterStatus('update')} className={`px-6 py-2.5 rounded-xl text-xs font-black uppercase transition-all ${filterStatus === 'update' ? 'bg-blue-600 text-white' : 'text-slate-500'}`}>Actualizar</button>
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto bg-white rounded-[2.5rem] shadow-2xl border border-slate-100 overflow-hidden mb-12">
                        <div className="overflow-x-auto">
                            <table className="w-full text-left border-collapse">
                                <thead>
                                    <tr className="bg-slate-50/50 border-b-2 border-slate-100">
                                        <th className="px-8 py-6 text-[10px] font-black text-slate-400 uppercase tracking-widest text-center">Imagen 1:1</th>
                                        <th className="px-6 py-6 text-[10px] font-black text-slate-400 uppercase tracking-widest">Producto</th>
                                        <th className="px-6 py-6 text-[10px] font-black text-slate-400 uppercase tracking-widest text-right">Anterior</th>
                                        <th className="px-6 py-6 text-[10px] font-black text-slate-400 uppercase tracking-widest text-right">Tarifa 2026</th>
                                        <th className="px-8 py-6 text-[10px] font-black text-slate-400 uppercase tracking-widest text-center">Estado</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-50">
                                    {filteredProducts.map((p) => (
                                        <ProductRow key={p.id} product={p} imageObj={productImages[p.id]} onImageUpload={handleImageUpload} onImageRemove={removeImage} />
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {notification && (
                        <div className="fixed bottom-8 right-8 animate-slide-in flex items-center gap-3 bg-slate-900 text-white px-6 py-4 rounded-2xl shadow-2xl z-50 border border-white/10">
                            <Icon name={notification.type === 'info' ? "info" : "check-circle-2"} className={notification.type === 'info' ? "text-blue-400" : "text-emerald-400"} />
                            <span className="font-bold text-sm">{notification.message}</span>
                        </div>
                    )}
                </div>
            );
        };

        const rootElement = document.getElementById('root');
        if (rootElement) {
            const root = ReactDOM.createRoot(rootElement);
            root.render(<App />);
        }
    </script>
</body>
</html>
